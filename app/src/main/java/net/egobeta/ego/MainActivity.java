//
// Copyright 2016 Amazon.com, Inc. or its affiliates (Amazon). All Rights Reserved.
//
// Code generated by AWS Mobile Hub. Amazon gives unlimited permission to 
// copy, distribute and modify it.
//
// Source code generated from template: aws-my-sample-app-android v0.7
//
package net.egobeta.ego;

import android.app.Activity;
import android.app.AlarmManager;
import android.app.PendingIntent;
import android.app.ProgressDialog;
import android.content.Context;
import android.content.Intent;
import android.content.res.Resources;

import android.graphics.Bitmap;
import android.graphics.Color;
import android.graphics.PorterDuff;
import android.graphics.RectF;
import android.graphics.Typeface;

import android.graphics.drawable.Drawable;
import android.os.AsyncTask;
import android.os.Build;
import android.os.Bundle;
import android.support.annotation.Nullable;
import android.support.v4.app.Fragment;
import android.support.v4.app.FragmentManager;
import android.support.v4.app.FragmentPagerAdapter;
import android.support.v4.content.LocalBroadcastManager;
import android.support.v4.util.SparseArrayCompat;
import android.support.v4.view.ViewPager;
import android.support.v7.app.AppCompatActivity;
import android.support.v7.widget.Toolbar;
import android.util.Log;
import android.util.TypedValue;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewTreeObserver;
import android.widget.AbsListView;



import net.amazonaws.mobile.AWSMobileClient;
import net.amazonaws.mobile.user.IdentityManager;
import net.astuetz.PagerSlidingTabStrip;
import net.egobeta.ego.Fragments.Fragment_Main;
import net.egobeta.ego.Fragments.Fragment_Main_Friends;
import net.egobeta.ego.Interfaces.ScrollTabHolder;
import net.egobeta.ego.Library.LocalDataBase;
import net.egobeta.ego.Settings.SettingsActivity;
import net.egobeta.ego.Table_Classes.User_Badges;
import net.egobeta.ego.Table_Classes.User_Profile;
import net.flavienlaurent.notboringactionbar.AlphaForegroundColorSpan;

import com.amazonaws.AmazonClientException;
import com.amazonaws.AmazonServiceException;
import com.amazonaws.mobileconnectors.cognito.Dataset;
import com.amazonaws.mobileconnectors.cognito.DefaultSyncCallback;
import com.amazonaws.mobileconnectors.cognito.Record;
import com.amazonaws.mobileconnectors.cognito.exceptions.DataStorageException;
import com.amazonaws.mobileconnectors.dynamodbv2.dynamodbmapper.DynamoDBMapper;
import com.facebook.AccessToken;
import com.facebook.GraphRequest;
import com.facebook.GraphResponse;
import com.facebook.login.LoginManager;
import com.jeremyfeinstein.slidingmenu.lib.SlidingMenu;
import com.viewpagerindicator.CirclePageIndicator;


import android.content.IntentFilter;
import android.content.BroadcastReceiver;
import android.widget.Button;
import android.widget.ImageButton;
import android.widget.ImageView;
import android.widget.ProgressBar;
import android.widget.RelativeLayout;
import android.widget.ScrollView;
import android.widget.TextView;
//import android.widget.Toast;


import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import java.util.ArrayList;
import java.util.List;

public class MainActivity extends AppCompatActivity implements ScrollTabHolder, ViewPager.OnPageChangeListener, View.OnClickListener{

     static Bitmap image;
    //AWS Variables
    DynamoDBMapper mapper = null;
    public IdentityManager identityManager = null; //The identity manager used to keep track of the current user account.


    //Other variables
    private int mMinHeaderTranslation;
    private final static String LOG_TAG = MainActivity.class.getSimpleName(); //Class name for log messages.
    Typeface typeface;
    private TypedValue mTypedValue = new TypedValue();
    Context context;
    EgoMap egoMap = null;
    public static Activity activity = null;
    private static String facebookId;
    private int mActionBarHeight;
    public int mMinHeaderHeight;
    private int mHeaderHeight;

    //View item variables
    private static View mHeader;
    ImageView mHeaderPicture;

    public static ImageView egoLogo;
    public static ScrollView scrollView;

    private ViewPager mViewPager = null;
//    private static Toolbar toolbar;
    public PagerSlidingTabStrip mPagerSlidingTabStrip;
    static AbsListView absListView;
//    static CirclePageIndicator pageIndicator;
    private static User_Badges userBadges;
    private static User_Profile userProfile;
    private GraphResponse response;
    ArrayList<String> friends_Ids = new ArrayList<String>(); //list to pass through to friends fragment
    boolean isCreated = false;
    private LocalDataBase mLocalDataBase;
    UserPinned mUserPinned;
    ArrayList<String> pinnedUsers = new ArrayList<String>();


    //New Variables
    private static RectF mRect1 = new RectF();
    private static RectF mRect2 = new RectF();



    @Override
    protected void onCreate(final Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        System.out.println("MAINACTIVITY: onCreate");
        /** Set up and initialize aws variables **/
        initializeAWSVariables();

        /** Set Content View **/
        setContentView(R.layout.activity_main);

        /**Initialize facebookId, context, egoMap, resources, typeface, and dimension items*/
        setUpNeededVariables();

        /** Sync pinned users and user permissions from server **/
        /** Chain ends at updateUI method which then initializes the pager adapter **/
//        syncPrivacySettings();
        loadPinnedUsers();

        /** Restart this Activity if an uncaught exception is found **/
//        Thread.setDefaultUncaughtExceptionHandler(new Thread.UncaughtExceptionHandler() {
//            @Override
//            public void uncaughtException(Thread thread, Throwable throwable) {
//                restart(context, 1);
//            }
//        });
    }


    public static void restart(Context context, int delay) {
        if (delay == 0) {
            delay = 1;
        }
        Log.e("", "restarting app");
        Intent restartIntent = context.getPackageManager()
                .getLaunchIntentForPackage(context.getPackageName() );
        PendingIntent intent = PendingIntent.getActivity(
                context, 0,
                restartIntent, PendingIntent.FLAG_CANCEL_CURRENT );
        AlarmManager manager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);
        manager.set(AlarmManager.RTC, System.currentTimeMillis() + delay, intent);
        System.exit(2);
    }

    //Initialize dimension variables for the animations
    private void initializeDimensionItems() {
        System.out.println("MAINACTIVITY: initializeDimensionItems");

        mMinHeaderHeight = getResources().getDimensionPixelSize(R.dimen.min_header_height);
        mHeaderHeight = getResources().getDimensionPixelSize(R.dimen.header_height);
        mMinHeaderTranslation = -mMinHeaderHeight + getActionBarHeight();
    }

    private void initializeAWSVariables() {
        activity = this;

        // Obtain a reference to the mobile client. It is created in the Application class,
        // but in case a custom Application class is not used, we initialize it here if necessary.
        AWSMobileClient.initializeMobileClientIfNecessary(this);
        // Obtain a reference to the mobile client. It is created in the Application class.
        final AWSMobileClient awsMobileClient = AWSMobileClient.defaultMobileClient();
        // Obtain a reference to the identity manager.
        identityManager = awsMobileClient.getIdentityManager();

        //Initialize the mapper for DynamoDB
        mapper = awsMobileClient.getDynamoDBMapper();
    }

//    private void setUpPageIndicator() {
//        pageIndicator = (CirclePageIndicator)findViewById(R.id.titles);
//        int tabPageColor = Color.parseColor("#5055C1AD");
//        int tabFillColor = Color.parseColor("#55C1AD");
//        pageIndicator.setStrokeColor(tabPageColor);
//        pageIndicator.setFillColor(tabFillColor);
//        pageIndicator.setPageColor(tabPageColor);
//        pageIndicator.setExtraSpacing(25f);
//        pageIndicator.setViewPager(mViewPager);
//    }

//    private void setUpToolBar() {
//        toolbar = (Toolbar) findViewById(R.id.toolbar);
//        setSupportActionBar(toolbar);
//        assert getSupportActionBar() != null;
//        getSupportActionBar().setDisplayHomeAsUpEnabled(true);
//        toolbar.setOnClickListener(this);
//        toolbar.setTitle(" ");
//        toolbar.setAlpha(1);
//    }

    private void setUpViewPager() {
        mViewPager = (ViewPager) findViewById(R.id.pager);
        mViewPager.setOffscreenPageLimit(3);
        mViewPager.setOverScrollMode(View.OVER_SCROLL_NEVER);
        PagerAdapter mPagerAdapter = new PagerAdapter(getSupportFragmentManager());
        mPagerAdapter.setTabHolderScrollingContent(this);
        mViewPager.setAdapter(mPagerAdapter);
    }

    private void loadPinnedUsers() {
        final UserPinned userPinned = UserPinned.getInstance(getApplicationContext());
        final Dataset dataset = userPinned.getDataset();
        final ProgressDialog dialog = ProgressDialog.show(this,
                getString(R.string.settings_fragment_dialog_title),
                getString(R.string.settings_fragment_dialog_message));
        Log.d(LOG_TAG, "Loading pinned users from remote");
        dataset.synchronize(new DefaultSyncCallback() {
            @Override
            public void onSuccess(final Dataset dataset, final List<Record> updatedRecords) {
                super.onSuccess(dataset, updatedRecords);
                userPinned.loadFromDataset();
                mUserPinned = userPinned;

                /** Run method to populate localdatabase with loaded pinned users **/
                syncPrivacySettings(dialog);

            }

            @Override
            public void onFailure(final DataStorageException dse) {
                Log.w(LOG_TAG, "Failed to load user settings from remote, using default.", dse);
                updateUI(dialog);
            }

            @Override
            public boolean onDatasetsMerged(final Dataset dataset,
                                            final List<String> datasetNames) {
                // Handle dataset merge. One can selectively copy records from merged datasets
                // if needed. Here, simply discard merged datasets
                for (String name : datasetNames) {
                    Log.d(LOG_TAG, "found merged datasets: " + name);
                    AWSMobileClient.defaultMobileClient().getSyncManager().openOrCreateDataset(name).delete();
                }
                return true;
            }
        });
    }

    /** Sync user's preferences only if user is signed in **/
    private void syncPrivacySettings(final ProgressDialog dialog) {
        System.out.println("MAINACTIVITY: syncPrivacySettings");
        // sync only if user is signed in
        if (AWSMobileClient.defaultMobileClient().getIdentityManager().isUserSignedIn()) {
            final UserPermissions userPermissions = UserPermissions.getInstance(getApplicationContext());
            userPermissions.getDataset().synchronize(new DefaultSyncCallback() {
                @Override
                public void onSuccess(final Dataset dataset, final List<Record> updatedRecords) {
                    super.onSuccess(dataset, updatedRecords);
                    Log.d(LOG_TAG, "successfully synced user settings");

                    runOnUiThread(new Runnable() {
                        @Override
                        public void run() {
                            loadUserSettings(dialog);
                        }
                    });
                }
            });
        }
    }

    /** userPermissions.loadFromDataset(); get called here **/
    private void loadUserSettings(final ProgressDialog dialog) {
        final UserPermissions userPermissions = UserPermissions.getInstance(getApplicationContext());
        final Dataset dataset = userPermissions.getDataset();
//        final ProgressDialog dialog = ProgressDialog.show(this,
//                getString(R.string.settings_fragment_dialog_title),
//                getString(R.string.settings_fragment_dialog_message));
        Log.d(LOG_TAG, "Loading user settings from remote");
        dataset.synchronize(new DefaultSyncCallback() {
            @Override
            public void onSuccess(final Dataset dataset, final List<Record> updatedRecords) {
                super.onSuccess(dataset, updatedRecords);
                userPermissions.loadFromDataset();
                getFacebookInfo(userPermissions, dialog);

            }

            @Override
            public void onFailure(final DataStorageException dse) {
                Log.w(LOG_TAG, "Failed to load user settings from remote, using default.", dse);
                updateUI(dialog);
            }

            @Override
            public boolean onDatasetsMerged(final Dataset dataset,
                                            final List<String> datasetNames) {
                // Handle dataset merge. One can selectively copy records from merged datasets
                // if needed. Here, simply discard merged datasets
                for (String name : datasetNames) {
                    Log.d(LOG_TAG, "found merged datasets: " + name);
                    AWSMobileClient.defaultMobileClient().getSyncManager().openOrCreateDataset(name).delete();
                }
                return true;
            }
        });
    }

    /** Get the info from the facebook api**/
    private void getFacebookInfo(final UserPermissions userPermissions, final ProgressDialog dialog) {
        Thread thread = new Thread() {
            @Override
            public void run() {
                try {
                    sleep(1000);
                    final Bundle parameters = new Bundle();
                    parameters.putString("fields", "name,picture.type(large), age_range, birthday, context, " +
                            "education, email, favorite_athletes, favorite_teams, hometown, inspirational_people, is_verified, " +
                            "languages, locale, location, work, movies, music, books, friends");
                    final GraphRequest graphRequest = new GraphRequest(AccessToken.getCurrentAccessToken(), "me");
                    graphRequest.setParameters(parameters);
                    response = graphRequest.executeAndWait();
                    getBadgeVariablesFromResponse(response, userPermissions, dialog);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        };
        thread.start();
    }

    /** Gets the variables set by the user's privacy preferences needed for the badge class **/
    public void getBadgeVariablesFromResponse(GraphResponse response, UserPermissions userPermissions, ProgressDialog dialog){
        userBadges = new User_Badges();

        //Get json object from response
        JSONObject json = response.getJSONObject();

        //Print json response for debugging purposes
//        printJsonResponse(json);

        //Parse json response into the corresponding variables
        try {
            userBadges.setFacebookId(facebookId);

            if(userPermissions.getFriends() == 1){
                //Need to set the badge variable to 1 so that the database can do a badge comparison on this badge
                userBadges.setFriend("1");
                // Get all friends from response and store in arraylist to pass through to ego friends fragment.
                //Create JSON array to store the friend items
                JSONArray friendArray = new JSONArray();

                //Get the items from the response JSONArray and add it to our custom json array
                JSONObject friendObject = json.getJSONObject("friends");
                JSONArray data = friendObject.getJSONArray("data");
                friends_Ids = new ArrayList<String>();
                for (int i = 0; i < data.length(); i++) {
                    JSONObject jsonobject = data.getJSONObject(i);
                    String friend_facebook_id = jsonobject.getString("id");

                    friends_Ids.add(friend_facebook_id);
                    System.out.println("MAINACTIVITY JSONPARSING: " + friend_facebook_id);
                }
            }

            if(userPermissions.getFriendsOfFriends() == 1){
                //Need to set the badge variable to 1 so that the database can do a badge comparison on this badge
                userBadges.setFriendsOfFriends("1");
            }

            if(userPermissions.getInstagramFollowers() == 1){
                //Need to set the badge variable to 1 so that the database can do a badge comparison on this badge
                userBadges.setInstagram_follower("1");
            }

            if(userPermissions.getInstagramFollowing() == 1){
                userBadges.setInstagram_following("1");
            }

            if(userPermissions.getLocation() == 1){
                JSONObject locationObject = json.getJSONObject("location");
                String location = locationObject.getString("name");
                userBadges.setLocation(location);
                System.out.println("MAINACTIVITY JSONPARSING: " + location);
            }

            if(userPermissions.getHometown() == 1){
                JSONObject hometownObject = json.getJSONObject("hometown");
                String hometown = hometownObject.getString("name");
                userBadges.setHometown(hometown);
                System.out.println("MAINACTIVITY JSONPARSING: " + hometown);
            }

            if(userPermissions.getCommonLikes() == 1){
                //Create JSON array to store the likes
                JSONArray likesArray = new JSONArray();

                //Get the items from the response JSONArray and add it to our custom json array
                JSONObject contextObject = json.getJSONObject("context");
                JSONObject mutualLikes = contextObject.getJSONObject("mutual_likes");
                JSONArray data = mutualLikes.getJSONArray("data");

                for (int i = 0; i < data.length(); i++) {
                    JSONObject jsonobject = data.getJSONObject(i);
                    String name = jsonobject.getString("name");

                    likesArray.put(name);
                }

                JSONObject likesObject = new JSONObject();
                likesObject.put("likes", likesArray);

                String likes_json = likesObject.toString();

                userBadges.setLikes_json(likes_json);
                System.out.println("MAINACTIVITY JSONPARSING: " + likes_json);
            }

            if(userPermissions.getBirthday() == 1){
                String birthday = json.getString("birthday");
                userBadges.setBirthday(birthday);
                System.out.println("MAINACTIVITY JSONPARSING: " + birthday);
            }

            if(userPermissions.getWorkplace() == 1){
                //Create JSON array to store the work items
                JSONArray workArray = new JSONArray();

                //Get the work array from the json response
                JSONArray data = json.getJSONArray("work");

                for (int i = 0; i < data.length(); i++) {
                    JSONObject workObject = data.getJSONObject(i);

                    //Get work position name
                    JSONObject positionObject = workObject.getJSONObject("position");
                    String position = positionObject.getString("name");

                    //Get work employer name
                    JSONObject employerObject = workObject.getJSONObject("employer");
                    String employer = employerObject.getString("name");

                    //Get work location name
                    JSONObject locationObject = workObject.getJSONObject("location");
                    String location = locationObject.getString("name");

                    JSONObject workItem = new JSONObject();
                    workItem.put("position", position);
                    workItem.put("employer", employer);
                    workItem.put("location", location);
                    workArray.put(workItem);
                }

                JSONObject workObject = new JSONObject();
                workObject.put("work", workArray);

                String workplace_json = workObject.toString();

                userBadges.setWorkplace_json(workplace_json);
                System.out.println("MAINACTIVITY JSONPARSING: " + workplace_json);
            }

            if(userPermissions.getSchool() == 1){
                //Create JSON array to store the school items
                JSONArray educationArray = new JSONArray();

                //Get the education array from the json response
                JSONArray data = json.getJSONArray("education");

                for (int i = 0; i < data.length(); i++) {
                    JSONObject educationObject = data.getJSONObject(i);

                    //Get school name
                    JSONObject schoolObject = educationObject.getJSONObject("school");
                    String school = schoolObject.getString("name");

                    educationArray.put(school);
                }

                JSONObject schoolsObject = new JSONObject();
                schoolsObject.put("schools", educationArray);

                String school_json = schoolsObject.toString();

                userBadges.setSchool_json(school_json);
                System.out.println("MAINACTIVITY JSONPARSING: " + school_json);
            }

            if(userPermissions.getSchool() == 1){
                //Create JSON array to store the skill items
                JSONArray skillsArray = new JSONArray();

                //Get the education array from the json response
                JSONArray data = json.getJSONArray("education");

                for (int i = 0; i < data.length(); i++) {
                    JSONObject educationObject = data.getJSONObject(i);

                    //Get skill name
                    JSONArray concentration = educationObject.getJSONArray("concentration");
                    for(int ii = 0; ii < concentration.length(); ii++){
                        JSONObject skillObject = concentration.getJSONObject(ii);
                        String skill = skillObject.getString("name");

                        skillsArray.put(skill);
                    }
                }

                JSONObject skillObject = new JSONObject();
                skillObject.put("skills", skillsArray);

                String professionalSkills_json = skillObject.toString();

                userBadges.setProfessionalSkills_json(professionalSkills_json);
                System.out.println("MAINACTIVITY JSONPARSING: " + professionalSkills_json);
            }

            if(userPermissions.getMusic() == 1){
                //Create JSON array to store the music items
                JSONArray musicArray = new JSONArray();

                //Get the items from the response JSONArray and add it to our custom json array
                JSONObject musicObject = json.getJSONObject("music");
                JSONArray data = musicObject.getJSONArray("data");

                for (int i = 0; i < data.length(); i++) {
                    JSONObject jsonobject = data.getJSONObject(i);
                    String name = jsonobject.getString("name");

                    musicArray.put(name);
                }

                musicObject = new JSONObject();
                musicObject.put("music", musicArray);

                String music_json = musicObject.toString();

                userBadges.setMusic_json(music_json);
                System.out.println("MAINACTIVITY JSONPARSING: " + music_json);
            }

            if(userPermissions.getMovies() == 1){
                //Create JSON array to store the movie items
                JSONArray moviesArray = new JSONArray();

                //Get the items from the response JSONArray and add it to our custom json array
                JSONObject movieObject = json.getJSONObject("movies");
                JSONArray data = movieObject.getJSONArray("data");

                for (int i = 0; i < data.length(); i++) {
                    JSONObject jsonobject = data.getJSONObject(i);
                    String name = jsonobject.getString("name");

                    moviesArray.put(name);
                }

                movieObject = new JSONObject();
                movieObject.put("movies", moviesArray);

                String movies_json = movieObject.toString();

                userBadges.setMovies_json(movies_json);
                System.out.println("MAINACTIVITY JSONPARSING: " + movies_json);
            }

            if(userPermissions.getBooks() == 1){
                //Create JSON array to store the book items
                JSONArray booksArray = new JSONArray();

                //Get the items from the response JSONArray and add it to our custom json array
                JSONObject bookObject = json.getJSONObject("books");
                JSONArray data = bookObject.getJSONArray("data");

                for (int i = 0; i < data.length(); i++) {
                    JSONObject jsonobject = data.getJSONObject(i);
                    String name = jsonobject.getString("name");

                    booksArray.put(name);
                }

                bookObject = new JSONObject();
                bookObject.put("books", booksArray);

                String books_json = bookObject.toString();

                userBadges.setBooks_json(books_json);
                System.out.println("MAINACTIVITY JSONPARSING: " + books_json);
            }
//            userName = json.getString("name");
//            userImageUrl = json.getJSONObject("picture")
//                    .getJSONObject("data")
//                    .getString("url");
        } catch (final JSONException jsonException) {
            Log.e("LOGTAG",
                    "Unable to get Facebook user info. " + jsonException.getMessage() + "\n" + response,
                    jsonException);
            // Nothing much we can do here.
        }

        /** Push userBadges item to server **/
        new SaveUserBadgesToDB(dialog).execute();
    }



    public static void blurTheBackground() {
        /** Blur the background for profile activity **/
        final View v = activity.getWindow().getDecorView();
        if (v.getWidth() > 0) {
            image = BlurBuilder.blur(v);

        } else {
            v.getViewTreeObserver().addOnGlobalLayoutListener(new ViewTreeObserver.OnGlobalLayoutListener() {
                @Override
                public void onGlobalLayout() {
                    image = BlurBuilder.blur(v);

                }
            });
        }
    }


    public class SaveUserBadgesToDB extends AsyncTask<Void, Void, Void> {
        ProgressDialog dialog;

        public SaveUserBadgesToDB(ProgressDialog dialog) {
            this.dialog = dialog;
        }

        @Override
        protected Void doInBackground(Void... params) {
            try{
                mapper.save(userBadges);
            } catch (AmazonClientException ex){
                ex.printStackTrace();
            }

            return null;
        }

        @Override
        protected void onPostExecute(Void aVoid) {
            super.onPostExecute(aVoid);
//            Toast.makeText(MainActivity.this, "Successfully saved user's badges to db", Toast.LENGTH_SHORT).show();
            new LoadUserProfile(dialog).execute();
        }
    }

    public class LoadUserProfile extends AsyncTask<Void, Void, Void> {
        ProgressDialog dialog;

        public LoadUserProfile(ProgressDialog dialog) {
            this.dialog = dialog;
        }

        @Override
        protected Void doInBackground(Void... params) {
            /** Load user profile from database before saving potential new facebook items  **/
            try {
                userProfile = mapper.load(User_Profile.class, facebookId);
            } catch (final AmazonServiceException e) {
                e.printStackTrace();
            }

            return null;
        }

        @Override
        protected void onPostExecute(Void aVoid) {
            super.onPostExecute(aVoid);
//            Toast.makeText(MainActivity.this, "Successfully loaded user profile from database", Toast.LENGTH_SHORT).show();
            updateUserProfile(dialog);
        }

    }


    /** Updates the user profile info needed from facebook **/
    public void updateUserProfile(ProgressDialog dialog){


        //Get json object from response
        JSONObject json = response.getJSONObject();

        try {
            /** Get the variables **/
            //Get name
            String name = json.getString("name");
            String firstAndLastNAme[] = name.split(" ");
            String firstName = firstAndLastNAme[0];
            String lastName = firstAndLastNAme[1];
            //Get age
            JSONObject ageRangeObject = json.getJSONObject("age_range");
            String age = ageRangeObject.getString("min");
            //Get email
            String email = json.getString("email");

            /** Set the variables **/
            userProfile.setFacebookId(facebookId); //Set facebookId
            userProfile.setFirstName(firstName); //Set first name
            userProfile.setLastName(lastName); //Set last name
            userProfile.setAge(age); //Set Age
            userProfile.setEmail(email); //Set email
        } catch (JSONException e) {
            e.printStackTrace();
        }

        /** Push userInfo item to server **/
        new SaveUserProfile(dialog).execute();
    }

    public class SaveUserProfile extends AsyncTask<Void, Void, Void> {
        ProgressDialog dialog;

        public SaveUserProfile(ProgressDialog dialog) {
            this.dialog = dialog;
        }

        @Override
        protected Void doInBackground(Void... params) {
            try{
                mapper.save(userProfile);
            } catch (AmazonClientException ex){
                ex.printStackTrace();
            }

            return null;
        }

        @Override
        protected void onPostExecute(Void aVoid) {
            super.onPostExecute(aVoid);
//            Toast.makeText(MainActivity.this, "Successfully saved user's info to db", Toast.LENGTH_SHORT).show();
            updateUI(dialog);
        }

    }


    /** Anything on the ui thread that needs changing after sync gets updated here **/
    private void updateUI(final ProgressDialog dialog) {
        this.runOnUiThread(new Runnable() {
            @Override
            public void run() {
                if (dialog != null) {
                    dialog.dismiss();
                }

                /**Initialize view item variables*/
                initializeViewItems();



                /**Set up the ViewPager and PagerAdapter*/
                setUpViewPager();

                /**Set up the SlidingTabStrip*/
                initializeSlidingTabStrip();

                /**Create top toolbar/menu bar*/
//                setUpToolBar();

                /**Get rid of the default arrow image*/
//                removeDefaultMenuButton();

//                /**Bind the Page indicator to the adapter*/
//                setUpPageIndicator();


                theMapOnCreateMethod();
                theMapOnStartMethod();
                theMapOnResumeMethod();

                isCreated = true; //This value is checked by the onResume method in case it tries to update any ui before its created
            }
        });
    }


    /** Divides json response from facebook info down into 5 lines to be printed **/
    private void printJsonResponse(JSONObject json) {
        int maxLogSize = 1000;
        for(int i = 0; i <= json.toString().length() / maxLogSize; i++) {
            int start = i * maxLogSize;
            int end = (i+1) * maxLogSize;
            end = end > json.toString().length() ? json.toString().length() : end;
            Log.d("MAINACTIVITY FB:  ", json.toString().substring(start, end));
        }
    }





    //Method to go to user settings
    public void settings() {
        System.out.println("MAINACTIVITY: settings");


        Intent intent = new Intent(this, SettingsActivity.class);
        startActivity(intent);
    }

    public void logout(){
        identityManager.signOut();
        LoginManager.getInstance().logOut();
        Intent intent = new Intent(MainActivity.this, SplashActivity.class);
        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);
        startActivity(intent);
        this.finish();
    }

//    public void blankActivity(){
//        identityManager.signOut();
//        Intent intent = new Intent(MainActivity.this, BlankActivity.class);
//        startActivity(intent);
//        this.finish();
//    }

    //Initialize some needed variables
    private void setUpNeededVariables() {
        System.out.println("MAINACTIVITY: setUpNeededVariables");
        facebookId = identityManager.getUserFacebookId();
        context = getApplicationContext();

        mLocalDataBase = new LocalDataBase(context);
        mLocalDataBase.clearUserData();

        egoMap = new EgoMap(MainActivity.this, getApplicationContext(), identityManager, mapper);
        Resources resources = getResources();
        typeface = Typeface.createFromAsset(getAssets(), "fonts/ChaletNewYorkNineteenEighty.ttf");

        /**Initialize dimension variables for the animations*/
        mMinHeaderHeight = getResources().getDimensionPixelSize(R.dimen.min_header_height);
        mHeaderHeight = getResources().getDimensionPixelSize(R.dimen.header_height);
        mMinHeaderTranslation = -mMinHeaderHeight + getActionBarHeight();
    }

    //Initialize view item variables
    private void initializeViewItems(){
        System.out.println("MAINACTIVITY: initializeViewItems");

        mHeader = findViewById(R.id.header); /**ENTIRE HEADER**/
        ImageView sideMenuArrow = (ImageView) findViewById(R.id.sidemenu_arrow); /**sideMenu arrow**/
        mHeaderPicture = (ImageView) findViewById(R.id.header_picture); /**HEADER - BLURRED BACKGROUND**/
        egoLogo = (ImageView) findViewById(R.id.ego_logo); /**HEADER - PROFILE PICTURE**/




    }

    //Method for header animation
    public int getActionBarHeight() {
        System.out.println("MAINACTIVITY: getActionBarHeight");

        if (mActionBarHeight != 0) {
            return mActionBarHeight;
        }
        getTheme().resolveAttribute(android.R.attr.actionBarSize, mTypedValue, true);
        mActionBarHeight = TypedValue.complexToDimensionPixelSize(mTypedValue.data, getResources().getDisplayMetrics());
        return mActionBarHeight;
    }

    //Set up the SlidingTabStrip
    private void initializeSlidingTabStrip() {
        System.out.println("MAINACTIVITY: initializeSlidingTabStrip");

        mPagerSlidingTabStrip = (PagerSlidingTabStrip) findViewById(R.id.tabs);
        mPagerSlidingTabStrip.setViewPager(mViewPager);
        mPagerSlidingTabStrip.getTabBackground();
        mPagerSlidingTabStrip.setOnPageChangeListener(this);
        AlphaForegroundColorSpan mAlphaForegroundColorSpan = new AlphaForegroundColorSpan(0xffffffff);
    }

    //Using custom image view as home as up indicator, this gets rid of the default arrow image
//    private void removeDefaultMenuButton(){
//        System.out.println("MAINACTIVITY: removeDefaultMenuButton");
//
//        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
//            upArrow = getDrawable(R.drawable.back_arrow_transparent);
//        } else {
//            upArrow = getResources().getDrawable(R.drawable.back_arrow_transparent);
//        }
//        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
//            upArrow.setColorFilter(getColor(R.color.transparentBackground), PorterDuff.Mode.SRC_ATOP);
//        }
//        getSupportActionBar().setHomeAsUpIndicator(upArrow);
//    }

    //Method to detect the scroll value of the Y axis
    public int getScrollY(AbsListView view) {
        System.out.println("MAINACTIVITY: getScrollY");

        View c = view.getChildAt(0);
        if (c == null) {
            return 0;
        }
        int firstVisiblePosition = view.getFirstVisiblePosition();
        int top = c.getTop();
        int headerHeight = 0;
        if (firstVisiblePosition >= 1) {
            headerHeight = mHeaderHeight;
        }
        return -top + firstVisiblePosition * c.getHeight() + headerHeight;
    }

    //Method for header animation
    public static float clamp(float value, float max, float min) {
        System.out.println("MAINACTIVITY: clamp");


        return Math.max(Math.min(value, min), max);
    }

    //Method to animate the title fade in/out
    private static void setTitleAlpha(float alpha) {
        System.out.println("MAINACTIVITY: setTitleAlpha");

//        mAlphaForegroundColorSpan.setAlpha(alpha);
//        mSpannableString.setSpan(mAlphaForegroundColorSpan, 0, mSpannableString.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
//        toolbar.setTitle(" ");
//        egoLogo.setAlpha(alpha * 1);
    }

    //Method to animate the homeAsUp indicator fade in/out
    private static void setHomeAsUpAlpha(float alpha) {
        System.out.println("MAINACTIVITY: setHomeAsUpAlpha");

//        toolbar.setAlpha(alpha * 1);
        egoLogo.setAlpha(alpha * 1);
//        pageIndicator.setAlpha(alpha * 1);
        mHeader.setAlpha(alpha * 1);
    }

//    private final BroadcastReceiver settingsChangedReceiver = new BroadcastReceiver() {
//        @Override
//        public void onReceive(Context context, Intent intent) {
//            Log.d(LOG_TAG, "Received settings changed local broadcast. Update theme colors.");
//            final ProgressDialog dialog = ProgressDialog.show(activity,
//                    getString(R.string.settings_fragment_dialog_title),
//                    getString(R.string.settings_fragment_dialog_message));
//            syncPrivacySettings(dialog);
//        }
//    };


    @Override
    protected void onPause() {
        System.out.println("MAINACTIVITY: onPause");

        super.onPause();
        Log.d("ACT DEBUG", "MainActivity: OnPause");
        // Obtain a reference to the mobile client.
        final AWSMobileClient awsMobileClient = AWSMobileClient.defaultMobileClient();

        // pause/resume Mobile Analytics collection
        awsMobileClient.handleOnPause();

        egoMap.theOnPauseMethod();


        // unregister notification receiver
//        LocalBroadcastManager.getInstance(this).unregisterReceiver(notificationReceiver);
//        LocalBroadcastManager.getInstance(this).unregisterReceiver(settingsChangedReceiver);
    }

    @Override
    protected void onResume() {
        System.out.println("MAINACTIVITY: onResume");

        super.onResume();
        Log.d("ACT DEBUG", "MainActivity: OnResume");
        mHeaderPicture = (ImageView) findViewById(R.id.header_picture); /**HEADER - BLURRED BACKGROUND**/


        final AWSMobileClient awsMobileClient = AWSMobileClient.defaultMobileClient();

        // pause/resume Mobile Analytics collection
        awsMobileClient.handleOnResume();

        // register notification receiver
//        LocalBroadcastManager.getInstance(this).registerReceiver(notificationReceiver,
//                new IntentFilter(PushListenerService.ACTION_SNS_NOTIFICATION));
//        // register settings changed receiver.
//        LocalBroadcastManager.getInstance(this).registerReceiver(settingsChangedReceiver,
//                new IntentFilter(UserPermissions.ACTION_PERMISSIONS_CHANGED));


        if(isCreated){
            theMapOnCreateMethod();
            theMapOnStartMethod();
            theMapOnResumeMethod();
        }


    }

    @Override
    protected void onStart() {
        System.out.println("MAINACTIVITY: onStart");

        super.onStart();
        Log.d("ACT DEBUG", "MainActivity: OnStart");
        mHeaderPicture = (ImageView) findViewById(R.id.header_picture);


    }


    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
        System.out.println("MAINACTIVITY: onCreateOptionsMenu");

//		return super.onCreateOptionsMenu(menu);
        getMenuInflater().inflate(R.menu.menu_main1, menu);
        return true;
    }

    /************************************** IMPLEMENTED METHODS ************************************/
    /***********************************************************************************************/

    @Override
    public void onClick(final View v) {
        System.out.println("MAINACTIVITY: onClick");

        switch(v.getId()){
            case R.id.toolbar:
                absListView.post(new Runnable() {
                    @Override
                    public void run() {
                        absListView.smoothScrollToPosition(0);
                    }
                });
//                Toast.makeText(this, "toolbar clicked mainActivity", Toast.LENGTH_SHORT).show();

        }

    }

    public static void backToTop(){
        System.out.println("MAINACTIVITY: backToTop");

        absListView.post(new Runnable() {
            @Override
            public void run() {
                absListView.smoothScrollToPosition(0);

            }
        });
    }

    @Override
    public void onPageScrolled(int position, float positionOffset, int positionOffsetPixels) {

    }

    @Override
    public void onPageSelected(int position) {
        System.out.println("MAINACTIVITY: onPageSelected");
    }

    @Override
    public void onPageScrollStateChanged(int state) {

    }



    @Override
    public void onScroll(AbsListView view, int firstVisibleItem, int visibleItemCount, int totalItemCount, int pagePosition) {
        if (mViewPager.getCurrentItem() == pagePosition) {
            absListView = view;
            int scrollY = getScrollY(view);

            mHeader.setTranslationY(Math.max(-scrollY, mMinHeaderTranslation));
            float ratio = clamp(mHeader.getTranslationY() / mMinHeaderTranslation, 0.0f, 1.0f);


            setTitleAlpha(clamp(5.0F * ratio - 4.0F, 0.0F, 1.0F));
            setHomeAsUpAlpha(clamp((5.0F * ratio - 4.0F) * -1, 0.0F, 1.0F));
        }
    }

    @Override
    public void adjustScroll(int scrollHeight) {
        // nothing
    }

    @Override
    public boolean onOptionsItemSelected(final MenuItem item) {
        System.out.println("MAINACTIVITY: onOptionsItemSelected");

        // Handle action bar item clicks here excluding the home button.
        switch (item.getItemId()) {
            case android.R.id.home:

                return true;
        }

        return super.onOptionsItemSelected(item);
    }

    //Method for header animation
    private static RectF getOnScreenRect(RectF rect, View view) {
        rect.set(view.getLeft(), view.getTop(), view.getRight(), view.getBottom());
        return rect;
    }

    //Method for header animation
    private static void interpolate(View view1, View view2, float interpolation) {
        getOnScreenRect(mRect1, view1);
        getOnScreenRect(mRect2, view2);

        float scaleX = 1.0F + interpolation * (mRect2.width() / mRect1.width() - 1.0F);
        float scaleY = 1.0F + interpolation * (mRect2.height() / mRect1.height() - 1.0F);
        float translationX = 0.5F * (interpolation * (mRect2.left + mRect2.right - mRect1.left - mRect1.right));
        float translationY = 0.5F * (interpolation * (mRect2.top + mRect2.bottom - mRect1.top - mRect1.bottom));

        view1.setTranslationX(translationX);
        view1.setTranslationY(translationY - mHeader.getTranslationY());
        view1.setScaleX(scaleX);
        view1.setScaleY(scaleY);
    }



    /************************************** INNER CLASSES ******************************************/
    /***********************************************************************************************/

//    //A Pager adapter that represents 2 ScreenSlidePageFragment objects, in sequence.
//    public class ScreenSlidePagerAdapter extends FragmentPagerAdapter {
//        int count = 0;
//        public ScreenSlidePagerAdapter(FragmentManager fm) {
//            super(fm);
//        }
//
//        //        What happens when page is swiped?
//        @Override
//        public Fragment getItem(int position) {
//            switch(position){
//                case 1:
//                    egoFriendsFragment = new EgoFriendsFragment();
//                    return egoFriendsFragment;
//                default: break;
//            }
//            egoStreamFragment = new EgoStreamFragment();
//            return egoStreamFragment;
//        }
//
//        @Override
//        public int getCount() {
//            return 2;
//        }
//    }

    //PagerAdapter for the sliding pages under user profile
    public class PagerAdapter extends FragmentPagerAdapter {

        private SparseArrayCompat<ScrollTabHolder> mScrollTabHolders;
        private final String[] TITLES = {" "};
        private ScrollTabHolder mListener;

        public PagerAdapter(FragmentManager fm) {
            super(fm);
            mScrollTabHolders = new SparseArrayCompat<ScrollTabHolder>();
        }

        public void setTabHolderScrollingContent(ScrollTabHolder listener) {
            mListener = listener;
        }

        @Override
        public CharSequence getPageTitle(int position) {
            return TITLES[position];
        }


        @Override
        public int getCount() {
            return TITLES.length;
        }


        @Override
        public Fragment getItem(int position) {

            Fragment_Main fragment;
            fragment = (Fragment_Main) Fragment_Main.newInstance(egoMap, identityManager, position, friends_Ids, mUserPinned);

            if (mListener != null) {
                fragment.setScrollTabHolder(mListener);

            }

            return fragment;

        }

        public SparseArrayCompat<ScrollTabHolder> getScrollTabHolders() {
            return mScrollTabHolders;
        }

    }










    /************************************** FINAL METHODS ******************************************/
    /***********************************************************************************************/

//    private final BroadcastReceiver notificationReceiver = new BroadcastReceiver() {
//        @Override
//        public void onReceive(Context context, Intent intent) {
//            Log.d(LOG_TAG, "Received notification from local broadcast. Display it in a dialog.");
//
//            Bundle data = intent.getBundleExtra(PushListenerService.INTENT_SNS_NOTIFICATION_DATA);
//            String message = PushListenerService.getMessage(data);
//
//            new AlertDialog.Builder(MainActivity.this)
//                    .setTitle(R.string.push_demo_title)
//                    .setMessage(message)
//                    .setPositiveButton(android.R.string.ok, null)
//                    .show();
//        }
//    };
//
//    private final BroadcastReceiver settingsChangedReceiver = new BroadcastReceiver() {
//        @Override
//        public void onReceive(Context context, Intent intent) {
//            Log.d(LOG_TAG, "Received settings changed local broadcast. Update theme colors.");
////            updateColor();
//        }
//    };
    /***********************************************************************************************/

    /********************************** Google Maps Methods ****************************************/
    /***********************************************************************************************/
    public void theMapOnCreateMethod(){
        System.out.println("MAINACTIVITY: theMapOnCreateMethod");

        egoMap.theOnCreateMethod();
    }

    public void theMapOnStartMethod(){
        System.out.println("MAINACTIVITY: theMapOnStartMethod");
        egoMap.theOnStartMethod();
    }

    @Nullable
    @Override
    public CharSequence onCreateDescription() {
        return super.onCreateDescription();
    }

    public void theMapOnResumeMethod(){
        System.out.println("MAINACTIVITY: theMapOnResumeMethod");
        egoMap.theOnResumeMethod();
    }

    public static void getNearbyUsers(int count, EgoMap egoMap){
        System.out.println("MAINACTIVITY: getNearbyUsers");
        egoMap.PushLocation(count);
    }










    /***********************************************************************************************/

    //     public class SaveToDB extends AsyncTask<Void, Void, Void> {
//
//
//        @Override
//        protected Void doInBackground(Void... params) {
//            try{
//                mapper.save(bookToSave);
//            } catch (AmazonClientException ex){
//                ex.printStackTrace();
//            }
//
//            return null;
//        }
//
//        @Override
//        protected void onPostExecute(Void aVoid) {
//            super.onPostExecute(aVoid);
//            Toast.makeText(getActivity(), "Successfully saved book to db", Toast.LENGTH_SHORT).show();
//        }
//    }
}
